<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f1e16" />
    <link rel="manifest" href="manifest.webmanifest" />
    <title>Plant Tracker</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%2308a57b' d='M50 8c8 20 23 25 23 38 0 9-7 15-15 17 4-10-1-24-8-33-7 9-12 23-8 33-8-2-15-8-15-17 0-13 15-18 23-38Z'/%3E%3Crect x='47' y='60' width='6' height='30' rx='3' fill='%232e3e37'/%3E%3C/svg%3E" />
    <link rel="stylesheet" href="tailwind.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="app-header sticky top-0 backdrop-blur border-b border-[color:var(--border)]">
      <h1>Plant Tracker</h1>
      <nav class="top-actions flex gap-2">
        <button id="addPlantBtn" class="btn primary px-3 py-2 rounded-xl">Add Plant</button>
        <button id="navPlants" class="btn px-3 py-2 rounded-xl" title="All plants">Plants</button>
        <button id="seedBtn" class="btn px-3 py-2 rounded-xl dev-only" style="display:none">Add Demo</button>
        
        <button id="exportBtn" class="btn px-3 py-2 rounded-xl">Export</button>
        <button id="updateBtn" class="btn px-3 py-2 rounded-xl dev-only" style="display:none" title="Force update service worker and refresh">Update</button>
        <button id="themeToggle" class="btn px-3 py-2 rounded-xl" title="Toggle theme"><i data-lucide="sun"></i></button>
        <button id="refreshIconsBtn" class="btn px-3 py-2 rounded-xl dev-only" style="display:none" title="Re-render icons">Icons</button>
        <a href="/health.html" class="btn px-3 py-2 rounded-xl dev-only" style="display:none" target="_blank" rel="noreferrer noopener">Health</a>
        <button id="settingsBtn" class="btn px-3 py-2 rounded-xl" title="Settings"><i data-lucide="settings"></i></button>
        <label class="import">
          <input id="importInput" type="file" accept="application/json" hidden />
          <span class="btn px-3 py-2 rounded-xl">Import</span>
        </label>
      </nav>
    </header>

    <main id="view-root">
      <section id="dashboardView" class="view active">
        <div class="toolbar flex items-end justify-between">
          <div>
            <h2 class="m-0">Tasks</h2>
            <div class="hint">Due now and upcoming</div>
          </div>
          <div class="flex gap-2 items-center">
            <div class="flex rounded-xl overflow-hidden border" style="border-color: var(--border)">
              <button id="viewToggleTasks" class="px-3 py-2 btn">Tasks</button>
              <button id="viewTogglePlants" class="px-3 py-2 btn">Plants</button>
            </div>
            <select id="taskTypeFilter" class="px-2 py-2 rounded-xl border" style="border-color: var(--border)">
              <option value="all">All</option>
              <option value="water">üíß Watering</option>
              <option value="other">‚ãØ Other</option>
            </select>
            <select id="taskWindowFilter" class="px-2 py-2 rounded-xl border" style="border-color: var(--border)">
              <option value="7">7 days</option>
              <option value="3">3 days</option>
              <option value="14">14 days</option>
              <option value="30">30 days</option>
            </select>
            <label class="flex items-center gap-1 text-[color:var(--muted)]">
              <input id="onlyOverdue" type="checkbox" />
              <span>Only overdue</span>
            </label>
            <button id="resetFilters" class="btn px-3 py-2 rounded-xl">Reset</button>
            <button id="legendToggle" class="btn px-3 py-2 rounded-xl" title="Show legend">Legend</button>
          </div>
        </div>

        <div id="legend" class="card" style="display:none; margin-bottom:8px">
          <div class="muted text-sm">Icons
            <div>üíß Water ‚Ä¢ üß™ Fertilize ‚Ä¢ ü™£ Repot ‚Ä¢ ‚úÇÔ∏è Prune ‚Ä¢ üîç Inspect ‚Ä¢ üí® Mist</div>
            <div>üåµ cactus / ü™¥ aroid/generic ‚Ä¢ üè† indoor ‚Ä¢ üå§ outdoor ‚Ä¢ N/E/S/W exposure</div>
          </div>
        </div>

        <div id="tasksSection" class="card">
          <h3 style="margin:4px 0">Due</h3>
          <ul id="dueList" class="plant-list grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
          <h3 style="margin:8px 0 4px">Upcoming</h3>
          <ul id="upcomingList" class="plant-list grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
        </div>
        <div class="toolbar flex items-end justify-between" style="margin-top:16px">
          <h2 class="m-0">Plants</h2>
          <div class="flex gap-2 items-center">
            <div class="flex rounded-xl overflow-hidden border" style="border-color: var(--border)">
              <button id="plantsViewCards" class="px-3 py-2 btn">Cards</button>
              <button id="plantsViewRows" class="px-3 py-2 btn">Rows</button>
            </div>
          </div>
        </div>
        <div id="plantsSection">
          <ul id="plantList" class="plant-list grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
        </div>
      </section>

      <!-- All Plants Page -->
      <section id="plantsPage" class="view">
        <div class="toolbar flex items-end justify-between">
          <div>
            <h2 class="m-0">All Plants</h2>
            <div class="hint">Browse and manage your collection</div>
          </div>
          <div class="flex gap-2 items-center">
            <input id="plantSearch" class="px-3 py-2 rounded-xl border" style="border-color: var(--border)" placeholder="Search plants" />
            <select id="plantSort" class="px-2 py-2 rounded-xl border" style="border-color: var(--border)">
              <option value="name">Name (A‚ÄìZ)</option>
              <option value="due">Next due</option>
              <option value="created">Recently added</option>
            </select>
            <div class="flex rounded-xl overflow-hidden border" style="border-color: var(--border)">
              <button id="plantsPageCards" class="px-3 py-2 btn">Cards</button>
              <button id="plantsPageRows" class="px-3 py-2 btn">Rows</button>
            </div>
          </div>
        </div>
        <ul id="allPlantList" class="plant-list grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
      </section>

      <div id="toast" class="toast"></div>

      <section id="plantDetailView" class="view">
        <div class="card" id="plantDetailCard">
          <div class="toolbar" style="justify-content:space-between; align-items:center">
            <div>
              <button id="detailBack" class="btn">Back</button>
            </div>
            <div class="flex" style="display:flex; gap:.5rem; align-items:center">
              <span id="plantDetailWx" class="pill wx-pill" style="display:none"></span>
              <button id="detailEdit" class="btn">Edit</button>
            </div>
          </div>
          <div id="plantDetailHeader" class="row">
            <h2 id="plantDetailTitle" class="m-0 text-xl font-semibold"></h2>
            <div id="plantDetailTaxon" class="muted text-sm"></div>
          </div>
          <div id="plantDetailCover" class="cover" style="width:100%; aspect-ratio: 16/9; border-radius:10px; border:1px solid var(--border); background: var(--panel-2);"></div>
          <div class="row">
            <div id="plantDetailStats" class="stats flex gap-2 flex-wrap"></div>
            <div class="actions-row">
              <button id="detailWater" class="btn">Watered</button>
              <input id="detailSnapInput" type="file" accept="image/*" capture="environment" hidden />
              <button id="detailSnap" class="btn">Snap</button>
            </div>
          </div>
          <div class="row grid gap-3 grid-cols-1">
            <div>
              <label>Observations</label>
              <div class="obs-row">
                <input id="detailObsNote" placeholder="Observation note" />
                <input id="detailObsPhoto" type="file" accept="image/*" />
                <button id="detailObsAdd" class="btn">Add</button>
              </div>
              <div id="detailObsList" class="obs-list" style="margin-top:8px"></div>
            </div>
            <div>
              <label>Tasks</label>
              <div id="detailTaskList" class="task-list"></div>
            </div>
            <div>
              <label>Notes</label>
              <div id="detailNotes" class="card p-3"></div>
            </div>
            <div>
              <label>History</label>
              <canvas id="detailChart" width="800" height="260"></canvas>
            </div>
          </div>
        </div>
      </section>

      
<section id="editorView" class="view">
  <div id="stepIndicator" class="step-progress" role="progressbar" aria-valuemin="1" aria-valuemax="5" aria-valuenow="1" aria-valuetext="Step 1 of 5" aria-label="Step 1 of 5" tabindex="0">
    <div class="bar"></div>
  </div>
  <div class="card" id="editorSteps">
    <div class="step" data-step="1" id="stepIdentify">
      <h2 class="text-xl mb-2">Identify</h2>
      <input id="plantName" placeholder="Plant name" class="px-3 py-2 rounded-xl border w-full mb-2" autocomplete="off" />
      <div id="taxoResults" class="taxo-suggestions mb-2"></div>
      <input id="plantPhoto" type="file" accept="image/*" capture="environment" class="mb-2" />
      <div id="photoPreview" class="mb-2"></div>
      <div class="actions gap-2">
        <button type="button" class="btn" id="cancelEdit">Cancel</button>
        <button type="button" data-next class="btn primary">Next</button>
      </div>
    </div>
    <div class="step hidden" data-step="2" id="stepLocation">
      <h2 class="text-xl mb-2">Location</h2>
      <div id="locationChips" class="flex flex-wrap gap-2 mb-4">
        <button type="button" class="chip" data-loc="Living Room">Living Room</button>
        <button type="button" class="chip" data-loc="Kitchen">Kitchen</button>
        <button type="button" class="chip" data-loc="Bedroom">Bedroom</button>
        <input id="newLocationInput" placeholder="Add Location" class="px-3 py-1 rounded-xl border" />
      </div>
      <label class="flex items-center gap-2 mb-4"><input type="checkbox" id="isOutdoor" />Outdoor</label>
      <div class="actions gap-2 mb-4">
        <button type="button" id="clearWeather" class="btn">Clear</button>
        <span id="weatherTag" class="muted"></span>
      </div>
      <div class="actions gap-2">
        <button type="button" data-prev class="btn">Back</button>
        <button type="button" data-next class="btn primary">Next</button>
      </div>
    </div>
    <div class="step hidden" data-step="3" id="stepPot">
      <h2 class="text-xl mb-2">Pot & Soil</h2>
      <div class="grid-2 gap-2 mb-4">
        <select id="potSize" class="px-3 py-2 rounded-xl border">
          <option value="4">4"</option>
          <option value="6" selected>6"</option>
          <option value="8">8"</option>
          <option value="10">10"</option>
        </select>
        <select id="soilType" class="px-3 py-2 rounded-xl border">
          <option value="generic" selected>Generic potting mix</option>
          <option value="aroid">Aroid/tropical mix</option>
          <option value="cactus">Cactus/succulent mix</option>
        </select>
      </div>
      <label class="flex items-center gap-2 mb-4"><input type="checkbox" id="hasDrain" checked />Drainage holes</label>
      <div class="actions gap-2">
        <button type="button" data-prev class="btn">Back</button>
        <button type="button" data-next class="btn primary">Next</button>
      </div>
    </div>
    <div class="step hidden" data-step="4" id="stepScience">
      <h2 class="text-xl mb-2">Science Panel</h2>
      <div id="carePlanDetails" class="muted mb-4">No plan</div>
      <div class="actions gap-2 mb-4">
        <button type="button" id="genCarePlan" class="btn">Generate Plan</button>
      </div>
      <div class="actions gap-2">
        <button type="button" data-prev class="btn">Back</button>
        <button type="button" data-next class="btn primary">Next</button>
      </div>
    </div>
    <div class="step hidden" data-step="5" id="stepConfirm">
      <h2 class="text-xl mb-2">Confirm</h2>
      <div id="confirmSummary" class="mb-4"></div>
      <div class="actions gap-2">
        <button type="button" data-prev class="btn">Back</button>
        <button type="button" id="addSpecimen" class="btn primary">Add Specimen</button>
      </div>
    </div>
  </div>
</section>
    </main>

    <!-- Modal removed in favor of full detail view -->

    <footer class="app-footer">
      <span>Local-first, offline-ready</span>
    </footer>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content card" style="max-width:680px">
        <div class="modal-header">
          <h3 class="m-0">Settings</h3>
          <button id="settingsClose" class="btn ghost">Close</button>
        </div>
        <div class="row">
          <label class="h3">User</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="card">
              <div class="muted mb-1">Theme</div>
            <div class="flex items-center gap-3">
              <label class="flex items-center gap-1"><input type="radio" name="themeOpt" value="auto" checked> Auto</label>
              <label class="flex items-center gap-1"><input type="radio" name="themeOpt" value="dark"> Dark</label>
              <label class="flex items-center gap-1"><input type="radio" name="themeOpt" value="light"> Light</label>
            </div>
          </div>
          <div class="card">
            <div class="muted mb-1">Plants View</div>
            <div class="flex items-center gap-3">
              <label class="flex items-center gap-1"><input type="radio" name="plantsViewOpt" value="cards" checked> Cards</label>
              <label class="flex items-center gap-1"><input type="radio" name="plantsViewOpt" value="rows"> Rows</label>
            </div>
          </div>
          <div class="card md:col-span-2">
            <div class="muted mb-1">Actions</div>
            <div class="flex flex-wrap gap-2">
              <button id="settingsReminders" class="btn px-3 py-2 rounded-xl">Download Reminders (.ics)</button>
            </div>
          </div>
        </div>
        <div class="row">
          <label class="h3">Science</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="card">
              <div class="muted mb-1">Season</div>
              <select id="seasonSelect" class="px-3 py-2 rounded-xl border" style="border-color: var(--border)">
                <option value="growing" selected>Growing</option>
                <option value="peak">Peak</option>
                <option value="dormant">Dormant</option>
              </select>
            </div>
            <div class="card">
              <div class="muted mb-1">Environment</div>
              <div class="grid grid-cols-2 gap-2">
                <input id="tempInput" type="number" step="0.1" placeholder="Temp ¬∞C" class="px-3 py-2 rounded-xl border" style="border-color: var(--border)" />
                <input id="rhInput" type="number" step="1" placeholder="RH %" class="px-3 py-2 rounded-xl border" style="border-color: var(--border)" />
              </div>
              <div class="muted mt-1">Model: <span id="modelSummary">‚Äî</span></div>
              <div class="actions" style="margin-top:.5rem; justify-content:flex-start">
                <button id="useWeather" class="btn px-3 py-2 rounded-xl" title="Fetch current Temp/RH from your location">Use Local Weather</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <label class="h3">Profile</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="card">
            <div class="muted mb-1">Display Name</div>
            <input id="profileName" class="px-3 py-2 rounded-xl border" placeholder="Your name" />
          </div>
          <div class="card">
            <div class="muted mb-1">Avatar Emoji</div>
            <input id="profileEmoji" class="px-3 py-2 rounded-xl border" placeholder="e.g., üåø" maxlength="4" />
          </div>
          <div class="card md:col-span-2">
            <div class="muted mb-1">Settings Backup</div>
            <div class="flex flex-wrap gap-2 items-center">
              <button id="settingsExport" class="btn px-3 py-2 rounded-xl">Export Settings</button>
              <label class="btn px-3 py-2 rounded-xl" for="settingsImportInput">Import Settings</label>
              <input id="settingsImportInput" type="file" accept="application/json" hidden />
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <label class="h3">Developer</label>
        <div class="card">
          <div class="flex flex-wrap gap-2 items-center">
            <label class="flex items-center gap-1"><input id="devHeaderToggle" type="checkbox"> Show dev tools in header</label>
            <button id="settingsSeed" class="btn">Add Demo</button>
            <button id="settingsUpdate" class="btn">Update</button>
            <button id="settingsIcons" class="btn">Icons</button>
            <a href="/health.html" class="btn" target="_blank" rel="noreferrer noopener">Health</a>
          </div>
        </div>
      </div>
      </div>
    </div>

    <script src="db.js"></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script type="module">
      import { createIcons, icons } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
      window.lucideRender = () => createIcons({ icons });
      window.lucideRender();
    </script>
    <script>
      (function(){
        function ready(){ return typeof window.lucideRender === 'function'; }
        if(ready()) return;
        setTimeout(() => {
          if(ready()) return window.lucideRender();
          var s = document.createElement('script');
          s.src = 'https://unpkg.com/lucide@latest';
          s.onload = function(){
            if(window.lucide && window.lucide.createIcons){
              window.lucideRender = function(){ window.lucide.createIcons(); };
              window.lucideRender();
            }
          };
          document.body.appendChild(s);
        }, 800);
      })();
    </script>
  </body>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      });
    }
  </script>
  </html>
